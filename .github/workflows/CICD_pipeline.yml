name: CI/CD Pipeline

on:
  push:
    branches:
      # - main
      # - dev
      - release/v*
  release:
    types: [created]
  workflow_dispatch:

permissions:
  packages: write
  contents: write

env:
  TAG: ${{ github.event.release.tag_name }}

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo
        uses: actions/checkout@v4

      - name: setup python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: install python requirements
        run: pip install flake8 pylint

      - name: lint the code
        run: |
          flake8 hello.py --exit-zero >> flake8_output.txt
          pylint hello.py
        continue-on-error: true
      
      - name: test the script
        # the output of the script should returns "Hello, World!" so we can grep it to check
        run: python hello.py | grep -i "hello" || exit 1

      - name: show summary
        run: |
          {
            echo '## Code Linting Summary ðŸ“ˆ'
            echo ''
            echo '- âœ… Linting check is passed'
            echo ''
            echo '#### flake8 results (insights): ðŸ”'
            echo '```'
            echo "$(cat flake8_output.txt)"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"
  
  build-and-push:
    needs: [lint-and-test]
    # permissions:
    #   packages: write
    #   contents: write # needed for push to release artifacts
    name: build/push docker image
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo
        uses: actions/checkout@v4

      - name: setup docker buildx
        uses: docker/setup-buildx-action@v3

      - name: login to docker registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          # password: ${{ secrets.GITHUB_TOKEN }}
          password: ${{ secrets.PAT }}

      - name: build and push
        run: |
          docker buildx build --push -t ghcr.io/${{ github.repository }}:$TAG .
          docker buildx build --push -t ghcr.io/${{ github.repository }}:latest .

          # add the latest image to the release artifacts:
          if [ ${{ github.event_name }} == 'release' ]; then
            # create the tar file of the image
            docker pull ghcr.io/${{ github.repository }}:$TAG
            docker save ghcr.io/${{ github.repository }}:$TAG -o docker-image-$TAG.tar
          fi

      - name: cache docker image tar file for the next job
        if: github.event_name == 'release'
        uses: actions/cache@v4
        with:
          path: ./docker-image-${{ github.event.release.tag_name }}.tar
          key: ${{ runner.os }}-cache-${{ github.sha }}

      - name: show summary
        run: |
          {
            echo "## Docker Build Summary $TAG ðŸš¢"
            echo ''
            echo '- âœ… Docker image building & pushing is passed'
            echo ''
            echo '#### To pull the docker image use:'
            echo '```bash'
            echo "docker pull ghcr.io/${{ github.repository }}:latest"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"


  update-releaes-artifacts:
    # permissions:
    #   packages: write
    #   contents: write # needed for push to release artifacts
    needs: [build-and-push]
    runs-on: ubuntu-latest
    steps:
      - name: get the image tar file from the cache
        if: github.event_name == 'release'
        uses: actions/cache@v4
        with:
          path: ./docker-image-${{ github.event.release.tag_name }}.tar
          key: ${{ runner.os }}-cache-${{ github.sha }}

      - name: upload docker image to release artifacts
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: docker-image-${{ github.event.release.tag_name }}.tar
          asset_name: docker-image-${{ github.event.release.tag_name }}.tar
          asset_content_type: application/octet-stream


  test-docker-image:
    needs: [build-and-push]
    # permissions:
    #   packages: read
    #   contents: read
    runs-on: ubuntu-latest
    steps:
      - name: login to Docker registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          # password: ${{ secrets.GITHUB_TOKEN }}
          password: ${{ secrets.PAT }}
      
      - name: pull the image to create a container from it
        run: docker pull ghcr.io/${{ github.repository }}:latest

      - name: run a container and apply a test command against it (remember CMD in the Dockerfile invokes the script at start)
        run: docker run --rm ghcr.io/${{ github.repository }}:latest | grep -i "hello" > test_results.txt || exit 1

      - name: artifacting test results
        uses: actions/upload-artifact@v4
        with:
          name: test_results
          path: test_results.txt

  ask-for-approval:
    needs: [test-docker-image]
    runs-on: ubuntu-latest
    steps:
      - name: send notification to infrom that we need an approval to continue
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{"text":\"$(echo "project [simplepipeline $TAG] CI/CD pipeline needs to review before deploy to production ðŸ“¢")\"}" \
          ${{ secrets.SLACK_WEBHOOK_URL }}


  deploy:
    needs: [test-docker-image]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: deploy
        run: echo "deploy $TAG to production...ðŸš€"

  notification:
    needs: [deploy]
    runs-on: ubuntu-latest
    steps:
      - name: notification
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{"text":\"$(echo "project [simplepipeline $TAG] has been deployed to production ðŸš€")\"}" \
          ${{ secrets.SLACK_WEBHOOK_URL }}
